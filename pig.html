<!DOCTYPE html>
<html lang="ca">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L'Avar√≠cia Trenca el Sac</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap');

        :root {
            --wood: #3e2723;
            --wood-light: #5d4037;
            --felt: #1b5e20;
            --pig-pink: #ffc0cb;
            --gold: #ffd700;
            --text: #efebe9;
        }

        /* Instructions Modal */
        #instructions-modal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .instr-content {
            background: #1a0505;
            padding: 40px;
            border: 4px double var(--gold);
            text-align: center;
            max-width: 600px;
            color: #fff;
            position: relative;
        }

        .instr-close {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #aaa;
            font-size: 2rem;
            cursor: pointer;
        }

        .instr-btn {
            padding: 10px 30px;
            font-size: 1.2rem;
            background: var(--gold);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            color: #1a0505;
            margin-top: 20px;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: var(--text);
            font-family: 'Cinzel', serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* Background */
        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 40%, #2a1a15, #000);
            z-index: -1;
        }

        /* UI Bar */
        #ui-bar {
            width: 100%;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            z-index: 10;
        }

        .btn-menu {
            text-decoration: none;
            color: var(--gold);
            font-size: 2rem;
        }

        /* Game Table */
        #table-container {
            position: relative;
            width: 800px;
            height: 500px;
            background: radial-gradient(circle, #3e2723, #1a0f0a);
            border: 15px solid #281a14;
            border-radius: 50px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8) inset, 0 0 20px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 40px;
            margin-top: 20px;
        }

        /* Players */
        .player-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .player-area.active {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid var(--gold);
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.2);
        }

        .player-info h2 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--gold);
        }

        .score-total {
            font-size: 2.5rem;
            font-weight: bold;
        }

        .score-round {
            font-size: 1.2rem;
            color: #aaa;
        }

        .round-val {
            color: #ff5252;
            font-weight: bold;
        }

        /* Center Area (Dice) */
        #center-area {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        #die {
            width: 120px;
            height: 120px;
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.5s;
        }

        #die img {
            width: 80%;
            height: 80%;
            object-fit: contain;
        }

        .die-rolling {
            animation: roll 0.5s infinite linear;
        }

        @keyframes roll {
            0% {
                transform: rotate(0deg) scale(1);
            }

            25% {
                transform: rotate(90deg) scale(0.8);
            }

            50% {
                transform: rotate(180deg) scale(1);
            }

            75% {
                transform: rotate(270deg) scale(0.8);
            }

            100% {
                transform: rotate(360deg) scale(1);
            }
        }

        /* Controls */
        #controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .btn-action {
            padding: 15px 40px;
            font-size: 1.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.5);
            transition: transform 0.1s;
        }

        .btn-action:active {
            transform: translateY(2px);
        }

        .btn-roll {
            background: #4caf50;
            color: #fff;
        }

        .btn-hold {
            background: #f44336;
            color: #fff;
        }

        .btn-disabled {
            background: #555;
            color: #888;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #2a1a15;
            padding: 40px;
            border: 4px double var(--gold);
            text-align: center;
            max-width: 500px;
            color: var(--text);
        }

        .relic-icon {
            font-size: 4rem;
            margin: 20px;
        }

        button.modal-btn {
            padding: 10px 20px;
            font-size: 1.2rem;
            background: var(--gold);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-weight: bold;
            color: #1a0505;
            margin-top: 20px;
        }

        /* Message Overlay */
        #msg-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            color: var(--gold);
            text-shadow: 0 0 20px #000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
    </style>
</head>

<body>

    <div id="ui-bar">
        <a href="menu.html" class="btn-menu">üè†</a>
        <h1 style="color:var(--gold); margin:0; font-size:1.5rem;">L'AVAR√çCIA TRENCA EL SAC</h1>
        <div style="display:flex; align-items:center; gap:10px; color:var(--gold);">
            <button id="mute-btn" style="background:none; border:none; font-size: 1.5rem; cursor: pointer;">üîä</button>
            <input type="range" id="volume" min="0" max="1" step="0.1" value="0.5" style="accent-color: var(--gold);">
        </div>
    </div>

    <div id="table-container">
        <!-- AI Player -->
        <div class="player-area" id="p2-area">
            <div class="player-info">
                <h2>Monsieur Marais</h2>
                <div class="score-round">Ronda: <span class="round-val" id="p2-round">0</span></div>
            </div>
            <div class="score-total" id="p2-score">0</div>
        </div>

        <!-- Center -->
        <div id="center-area">
            <div id="die">
                <img src="images/rodona.jpg" id="die-img">
            </div>
            <div id="msg-overlay">SILENCI!</div>
        </div>

        <!-- Human Player -->
        <div class="player-area active" id="p1-area">
            <div class="player-info">
                <h2>Tu</h2>
                <div class="score-round">Ronda: <span class="round-val" id="p1-round">0</span></div>
            </div>
            <div class="score-total" id="p1-score">0</div>
        </div>
    </div>

    <div id="controls">
        <button class="btn-action btn-roll" id="btn-roll" onclick="rollDice()">LLAN√áAR</button>
        <button class="btn-action btn-hold" id="btn-hold" onclick="hold()">PLANTAR-SE</button>
    </div>

    <p style="color:#aaa; margin-top:10px;">Arriba a 50 punts. El Silenci (0) et fa perdre els punts de la ronda.</p>

    <p style="color:#aaa; margin-top:10px;">Arriba a 50 punts. El Silenci (0) et fa perdre els punts de la ronda.</p>

    <!-- Instructions Modal -->
    <div id="instructions-modal" class="modal" style="display: flex;">
        <div class="modal-content">
            <h2 style="color: var(--gold);">L'AVAR√çCIA TRENCA EL SAC</h2>
            <p>Acumula punts llan√ßant el dau.</p>
            <p>Si surt un SILENCI (0), perds els punts de la ronda.</p>
            <p>Pots plantar-te per guardar els punts.</p>
            <p>El primer en arribar a 50 guanya.</p>
            <button class="modal-btn"
                onclick="document.getElementById('instructions-modal').style.display='none'">COMEN√áAR</button>
        </div>
    </div>
    <div id="win-modal" class="modal">
        <div class="modal-content">
            <h2 style="color: var(--gold);">MESTRE DE LA VIOLA!</h2>
            <div class="relic-icon">üéª</div>
            <p style="font-size: 1.5rem; font-weight:bold;">"LA VIOLA DE GAMBA DE MARIN MARAIS"</p>
            <p>El virtu√≥s de la cort de Versalles. Es jugava la fortuna a les cartes mentre componia suites per a viola.
            </p>
            <button class="modal-btn" onclick="location.reload()">TORNAR A JUGAR</button>
        </div>
    </div>

    <!-- Lose Modal -->
    <div id="lose-modal" class="modal">
        <div class="modal-content">
            <h2 style="color: red;">DERROTA</h2>
            <p>Monsieur Marais ha arribat primer als 50 punts.</p>
            <button class="modal-btn" onclick="location.reload()">REINTENTAR</button>
        </div>
    </div>

    <audio id="bg-music" src="music/High Stakes Love.mp3" loop></audio>

    <script>
        // Audio
        // Audio
        const bgMusic = document.getElementById('bg-music');
        const muteBtn = document.getElementById('mute-btn');
        let isMuted = false;
        let previousVolume = 0.5;

        document.body.addEventListener('click', () => {
            if (bgMusic.paused && !isMuted) {
                bgMusic.volume = document.getElementById('volume').value * 0.5;
                bgMusic.play().catch(e => console.log(e));
            }
        }, { once: true });

        document.getElementById('volume').addEventListener('input', (e) => {
            if (isMuted) {
                isMuted = false;
                muteBtn.textContent = 'üîä';
            }
            bgMusic.volume = e.target.value * 0.5;
        });

        muteBtn.addEventListener('click', () => {
            isMuted = !isMuted;
            if (isMuted) {
                previousVolume = bgMusic.volume;
                bgMusic.volume = 0;
                muteBtn.textContent = 'üîá';
            } else {
                bgMusic.volume = document.getElementById('volume').value * 0.5;
                muteBtn.textContent = 'üîä';
            }
        });

        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        function playSound(type) {
            const vol = document.getElementById('volume').value;
            if (vol <= 0) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'roll') {
                // Shaking sound (noise)
                const bufferSize = audioCtx.sampleRate * 0.5;
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = Math.random() * 2 - 1;
                }
                const noise = audioCtx.createBufferSource();
                noise.buffer = buffer;
                const noiseFilter = audioCtx.createBiquadFilter();
                noiseFilter.type = 'lowpass';
                noiseFilter.frequency.value = 1000;
                noise.connect(noiseFilter);
                noiseFilter.connect(gain);
                gain.gain.setValueAtTime(vol * 0.5, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.5);
                noise.start();
            } else if (type === 'score') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
                gain.gain.setValueAtTime(vol * 0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start();
                osc.stop(now + 0.1);
            } else if (type === 'bust') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(50, now + 0.5);
                gain.gain.setValueAtTime(vol * 0.5, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.start();
                osc.stop(now + 0.5);
            } else if (type === 'hold') {
                // Coin sound
                osc.type = 'square';
                osc.frequency.setValueAtTime(1200, now);
                osc.frequency.exponentialRampToValueAtTime(2000, now + 0.1);
                gain.gain.setValueAtTime(vol * 0.2, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start();
                osc.stop(now + 0.2);
            }
        }

        // Game Logic
        const WIN_SCORE = 50;
        const FACES = [
            { val: 0, img: 'images/silencinegra.jpg', name: 'SILENCI' }, // 0: Bust
            { val: 1, img: 'images/semicorxera.jpg', name: 'Semicorxera' },
            { val: 2, img: 'images/corxera.jpg', name: 'Corxera' },
            { val: 3, img: 'images/negra.jpg', name: 'Negra' },
            { val: 4, img: 'images/blanca.jpg', name: 'Blanca' },
            { val: 5, img: 'images/rodona.jpg', name: 'Rodona' }
        ];

        let scores = [0, 0]; // P1, P2
        let roundScore = 0;
        let activePlayer = 0; // 0: Human, 1: AI
        let isRolling = false;
        let gameActive = true;

        function rollDice() {
            if (!gameActive || isRolling) return;

            isRolling = true;
            playSound('roll');
            const dieEl = document.getElementById('die');
            dieEl.classList.add('die-rolling');

            setTimeout(() => {
                dieEl.classList.remove('die-rolling');

                // Random 0-5
                const roll = Math.floor(Math.random() * 6);
                const face = FACES[roll];

                document.getElementById('die-img').src = face.img;

                if (roll === 0) {
                    // Bust
                    playSound('bust');
                    showMsg("SILENCI!");
                    roundScore = 0;
                    updateUI();
                    switchPlayer();
                } else {
                    // Score
                    playSound('score');
                    roundScore += face.val;
                    updateUI();
                    isRolling = false;

                    // AI Logic continuation
                    if (activePlayer === 1) {
                        setTimeout(aiTurn, 1000);
                    }
                }
            }, 500);
        }

        function hold() {
            if (!gameActive || isRolling || roundScore === 0) return;

            playSound('hold');
            scores[activePlayer] += roundScore;
            roundScore = 0;
            updateUI();

            if (scores[activePlayer] >= WIN_SCORE) {
                gameActive = false;
                if (activePlayer === 0) {
                    // Win
                    // Save Reward
                    const rewards = JSON.parse(sessionStorage.getItem('casinoRewards') || '{}');
                    rewards['reward_pig'] = true;
                    sessionStorage.setItem('casinoRewards', JSON.stringify(rewards));
                    setTimeout(() => document.getElementById('win-modal').style.display = 'flex', 500);
                } else {
                    // Lose
                    setTimeout(() => document.getElementById('lose-modal').style.display = 'flex', 500);
                }
            } else {
                switchPlayer();
            }
        }

        function switchPlayer() {
            activePlayer = activePlayer === 0 ? 1 : 0;
            roundScore = 0;
            isRolling = false;
            updateUI();

            if (activePlayer === 1) {
                // AI Start
                toggleControls(false);
                setTimeout(aiTurn, 1000);
            } else {
                // Human Turn
                toggleControls(true);
            }
        }

        function aiTurn() {
            if (!gameActive || activePlayer !== 1) return;

            // AI Strategy: Hold if >= 15 or winning
            if (scores[1] + roundScore >= WIN_SCORE) {
                hold();
            } else if (roundScore >= 15) {
                hold();
            } else {
                rollDice();
            }
        }

        function updateUI() {
            document.getElementById('p1-score').textContent = scores[0];
            document.getElementById('p2-score').textContent = scores[1];

            document.getElementById('p1-round').textContent = activePlayer === 0 ? roundScore : 0;
            document.getElementById('p2-round').textContent = activePlayer === 1 ? roundScore : 0;

            document.getElementById('p1-area').classList.toggle('active', activePlayer === 0);
            document.getElementById('p2-area').classList.toggle('active', activePlayer === 1);
        }

        function toggleControls(enable) {
            const btnRoll = document.getElementById('btn-roll');
            const btnHold = document.getElementById('btn-hold');

            if (enable) {
                btnRoll.classList.remove('btn-disabled');
                btnHold.classList.remove('btn-disabled');
                btnRoll.disabled = false;
                btnHold.disabled = false;
            } else {
                btnRoll.classList.add('btn-disabled');
                btnHold.classList.add('btn-disabled');
                btnRoll.disabled = true;
                btnHold.disabled = true;
            }
        }

        function showMsg(txt) {
            const el = document.getElementById('msg-overlay');
            el.textContent = txt;
            el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0, 1000);
        }

    </script>
</body>

</html>