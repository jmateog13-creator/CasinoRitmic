<!DOCTYPE html>
<html lang="ca">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Gran Subasta R√≠tmica</title>
    <style>
        :root {
            --red: #8b0000;
            --gold: #ffd700;
            --bg: #1a0505;
            --text: #f5e6d3;
            --wood-dark: #3e2723;
        }

        /* Instructions Modal */
        #instructions-modal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .instr-content {
            background: #1a0505;
            padding: 40px;
            border: 4px double var(--gold);
            text-align: center;
            max-width: 600px;
            color: #fff;
            position: relative;
        }

        .instr-close {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #aaa;
            font-size: 2rem;
            cursor: pointer;
        }

        .instr-btn {
            padding: 10px 30px;
            font-size: 1.2rem;
            background: var(--gold);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            color: #1a0505;
            margin-top: 20px;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Times New Roman', serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            user-select: none;
        }

        /* UI Bar */
        #ui-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            z-index: 1000;
        }

        .btn-menu {
            text-decoration: none;
            color: var(--gold);
            border: 1px solid var(--gold);
            padding: 5px 15px;
            border-radius: 5px;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.5);
            transition: all 0.2s;
        }

        .btn-menu:hover {
            background: var(--gold);
            color: #000;
        }

        /* Background & Room */
        #room {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #000 0%, #2a0a10 100%);
            z-index: -1;
        }

        .curtain {
            position: absolute;
            top: 0;
            width: 30%;
            height: 100%;
            background: repeating-linear-gradient(90deg, #8b0000, #5c0000 20px, #8b0000 40px);
            box-shadow: 10px 0 20px rgba(0, 0, 0, 0.5);
        }

        .curtain-left {
            left: 0;
            border-right: 5px solid var(--gold);
        }

        .curtain-right {
            right: 0;
            border-left: 5px solid var(--gold);
        }

        /* Podium */
        #podium {
            position: absolute;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 200px;
            background: #4a3c31;
            border: 5px solid var(--gold);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 10px 30px #000;
        }

        #auctioneer {
            font-size: 4rem;
            margin-bottom: 10px;
        }

        #lot-display {
            background: #fff;
            color: #000;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 1.2rem;
            text-align: center;
        }

        /* Rivals */
        .rival {
            position: absolute;
            top: 40%;
            width: 150px;
            text-align: center;
        }

        .rival-icon {
            font-size: 3rem;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.3));
        }

        .rival-bubble {
            background: #fff;
            color: #000;
            padding: 10px;
            border-radius: 15px;
            margin-top: 10px;
            opacity: 0;
            transition: opacity 0.5s;
            font-weight: bold;
        }

        #rival1 {
            left: 20%;
        }

        #rival2 {
            right: 20%;
        }

        /* Player Area */
        #player-area {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 35%;
            background: rgba(0, 0, 0, 0.8);
            border-top: 4px solid var(--gold);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        #hand {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .card {
            width: 60px;
            height: 90px;
            background: #fff;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s, border 0.2s;
            border: 2px solid #ccc;
        }

        .card img {
            width: 40px;
            height: 40px;
        }

        .card.selected {
            transform: translateY(-20px);
            border: 3px solid #0f0;
            box-shadow: 0 0 15px #0f0;
        }

        #controls {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        #bid-btn {
            padding: 15px 50px;
            font-size: 1.5rem;
            background: var(--gold);
            color: #000;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 0 #b8860b;
        }

        #bid-btn:active {
            transform: translateY(5px);
            box-shadow: none;
        }

        #current-bid {
            font-size: 1.5rem;
            color: var(--gold);
            text-shadow: 1px 1px 0 #000;
        }

        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal-content {
            background: #4a0a10;
            padding: 40px;
            border: 4px double var(--gold);
            border-radius: 10px;
            text-align: center;
            max-width: 600px;
            color: var(--text);
            box-shadow: 0 0 50px var(--gold);
        }

        .relic-icon {
            font-size: 5rem;
            margin: 20px 0;
        }

        /* Animations */
        @keyframes hammer {
            0% {
                transform: rotate(0deg);
            }

            50% {
                transform: rotate(-45deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }

        .hammer-anim {
            animation: hammer 0.2s ease-in-out;
        }
    </style>
</head>

<body>

    <div id="ui-bar">
        <div style="display:flex; align-items:center; gap:10px; color:var(--gold);">
            <span>üîä</span>
            <input type="range" id="volume" min="0" max="1" step="0.1" value="0.5" style="accent-color:var(--gold);">
        </div>
        <a href="menu.html" class="btn-menu">üè† MEN√ö</a>
    </div>

    <!-- Instructions Modal -->
    <div id="instructions-modal">
        <div class="instr-content">
            <span class="instr-close"
                onclick="document.getElementById('instructions-modal').style.display='none'">√ó</span>
            <h2 style="color: var(--gold);">COM JUGAR</h2>
            <p style="font-size:1.2rem;">Puja pels lots d'instruments i partitures valuoses.</p>
            <p>Gestiona el teu pressupost i guanya la subhasta!</p>
            <button class="instr-btn"
                onclick="document.getElementById('instructions-modal').style.display='none'">JUGAR</button>
        </div>
    </div>

    <div id="room">
        <div class="curtain curtain-left"></div>
        <div class="curtain curtain-right"></div>
    </div>

    <div id="podium">
        <div id="auctioneer">üë®‚Äç‚öñÔ∏è</div>
        <div id="lot-display">LOTE N¬∫ 1<br>Objectiu: <span id="target-val">3.0</span> Temps</div>
    </div>

    <div id="rival1" class="rival">
        <div class="rival-icon">üë∏</div>
        <div>Baronessa Beat</div>
        <div id="bubble1" class="rival-bubble">...</div>
    </div>

    <div id="rival2" class="rival">
        <div class="rival-icon">üßõ‚Äç‚ôÇÔ∏è</div>
        <div>Comte Comp√†s</div>
        <div id="bubble2" class="rival-bubble">...</div>
    </div>

    <div id="player-area">
        <div id="current-bid">OFERTA ACTUAL: <span id="bid-val">0</span></div>
        <div id="hand">
            <!-- Cards generated by JS -->
        </div>
        <div id="controls">
            <button id="bid-btn" onclick="submitBid()">PUJAR!</button>
        </div>
    </div>

    <!-- Start Modal -->
    <div id="start-modal" class="modal" style="display: flex;">
        <div class="modal-content">
            <h2 style="color: var(--gold);">LA GRAN SUBASTA</h2>
            <p>Benvingut a la Casa de Subastes VIP.</p>
            <p>Has d'igualar el valor de l'objecte amb les teves notes.</p>
            <p>Acosta't el m√†xim possible sense passar-te!</p>
            <button id="bid-btn" onclick="startGame()">ENTRAR A LA SALA</button>
        </div>
    </div>

    <!-- Win Modal -->
    <div id="win-modal" class="modal">
        <div class="modal-content">
            <h2 style="color: var(--gold);">JOIA DEL BARROC!</h2>
            <div class="relic-icon">üéπ</div>
            <p style="font-size: 1.5rem; color: #dcb;">"EL CLAVIC√àMBAL DAURAT DE SCARLATTI"</p>
            <p>Un instrument de teclat exquisit, pare del piano, usat a les corts reials del segle XVIII.</p>
            <button id="bid-btn" onclick="location.reload()">TORNAR AL CASINO</button>
        </div>
    </div>

    <!-- Round Result Modal -->
    <div id="result-modal" class="modal">
        <div class="modal-content">
            <h2 id="round-title">RESULTAT</h2>
            <p id="round-msg">...</p>
            <button id="bid-btn" onclick="nextRound()">SEG√úENT LOTE</button>
        </div>
    </div>

    <audio id="bg-music" src="music/background_music_subasta.mp3" loop></audio>
    <script>
        // Background Music
        document.body.addEventListener('click', () => {
            const bgMusic = document.getElementById('bg-music');
            if (bgMusic.paused) {
                bgMusic.volume = document.getElementById('volume').value * 0.5;
                bgMusic.play().catch(e => console.log(e));
            }
        }, { once: true });

        document.getElementById('volume').addEventListener('input', (e) => {
            const bgMusic = document.getElementById('bg-music');
            bgMusic.volume = e.target.value * 0.5;
        });

        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        const NOTES = [
            { name: 'rodona', val: 4, img: 'images/rodona.jpg' },
            { name: 'blanca', val: 2, img: 'images/blanca.jpg' },
            { name: 'negra', val: 1, img: 'images/negra.jpg' },
            { name: 'corxera', val: 0.5, img: 'images/corxera.jpg' },
            { name: 'semicorxera', val: 0.25, img: 'images/semicorxera.jpg' }
        ];

        let round = 1;
        let wins = 0;
        let target = 0;
        let hand = [];
        let selectedIndices = new Set();
        let playerBid = 0;

        function playSound(type) {
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'gavel') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(100, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'ding') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(880, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1);
                osc.start();
                osc.stop(audioCtx.currentTime + 1);
            }
        }

        function startGame() {
            document.getElementById('start-modal').style.display = 'none';
            if (audioCtx.state === 'suspended') audioCtx.resume();
            startRound();
        }

        function startRound() {
            document.getElementById('result-modal').style.display = 'none';

            // Reset UI
            document.getElementById('bubble1').style.opacity = 0;
            document.getElementById('bubble2').style.opacity = 0;
            selectedIndices.clear();
            updateBidDisplay();

            // Set Target
            target = (Math.floor(Math.random() * 8) + 4) * 0.5; // Random between 2.0 and 6.0
            // document.getElementById('target-val').textContent = "???"; // Hidden for user
            document.getElementById('lot-display').innerHTML = `LOTE N¬∫ ${round}<br>Objectiu: <span style="color:var(--red); font-size:1.5rem;">${target}</span> TEMPS`;

            // Deal Hand (Random assortment)
            hand = [];
            const handSize = 10;
            for (let i = 0; i < handSize; i++) {
                hand.push(NOTES[Math.floor(Math.random() * NOTES.length)]);
            }
            renderHand();
        }

        function renderHand() {
            const container = document.getElementById('hand');
            container.innerHTML = '';
            hand.forEach((card, idx) => {
                const el = document.createElement('div');
                el.className = `card ${selectedIndices.has(idx) ? 'selected' : ''}`;
                el.innerHTML = `<img src="${card.img}">`;
                el.onclick = () => toggleCard(idx);
                container.appendChild(el);
            });
        }

        function toggleCard(idx) {
            if (selectedIndices.has(idx)) {
                selectedIndices.delete(idx);
            } else {
                selectedIndices.add(idx);
            }
            renderHand(); // Re-render to show selection
            updateBidDisplay();
        }

        function updateBidDisplay() {
            playerBid = 0;
            selectedIndices.forEach(idx => {
                playerBid += hand[idx].val;
            });
            // "en la subasta.html me refieor a que no se va el numero de la suma del usuario, no la suma que debe dar el beote, si no no tiene sentido"
            // User wants to see THEIR current sum.
            document.getElementById('current-bid').textContent = "LA TEVA OFERTA: " + playerBid + " TEMPS";
        }

        function submitBid() {
            // AI Logic
            // Baronessa (Conservative): Tries to get close but stays under. Error margin -0.5 to 0.
            let ai1Bid = target - (Math.random() * 0.5);
            if (Math.random() < 0.2) ai1Bid -= 0.5; // Sometimes very conservative

            // Count (Risky): Tries to hit exact but might go over. Error margin -0.25 to +0.5.
            let ai2Bid = target + (Math.random() * 0.75 - 0.25);

            // Round to nearest 0.25 for realism
            ai1Bid = Math.round(ai1Bid * 4) / 4;
            ai2Bid = Math.round(ai2Bid * 4) / 4;

            // Show AI thinking...
            document.getElementById('bubble1').textContent = "...";
            document.getElementById('bubble1').style.opacity = 1;
            document.getElementById('bubble2').textContent = "...";
            document.getElementById('bubble2').style.opacity = 1;

            setTimeout(() => {
                // Reveal
                document.getElementById('bubble1').textContent = ai1Bid;
                document.getElementById('bubble2').textContent = ai2Bid;
                playSound('gavel');

                determineWinner(playerBid, ai1Bid, ai2Bid);
            }, 1500);
        }

        function determineWinner(p, a1, a2) {
            // Rules: Closest to target WITHOUT going over.
            let pDiff = target - p;
            let a1Diff = target - a1;
            let a2Diff = target - a2;

            // If diff is negative, they busted (disqualified)
            let pValid = pDiff >= 0;
            let a1Valid = a1Diff >= 0;
            let a2Valid = a2Diff >= 0;

            let winner = null;
            let minDiff = 999;

            if (pValid && pDiff < minDiff) { minDiff = pDiff; winner = 'player'; }
            if (a1Valid && a1Diff < minDiff) { minDiff = a1Diff; winner = 'baronessa'; }
            if (a2Valid && a2Diff < minDiff) { minDiff = a2Diff; winner = 'count'; }

            // Tie breaker? Player wins ties.
            if (pValid && a1Valid && pDiff === a1Diff) winner = 'player';
            if (pValid && a2Valid && pDiff === a2Diff) winner = 'player';

            let msg = "";
            if (winner === 'player') {
                wins++;
                msg = "HAS GUANYAT EL LOTE!";
                playSound('ding');
            } else if (winner === 'baronessa') {
                msg = "La Baronessa s'emporta el lote.";
            } else if (winner === 'count') {
                msg = "El Comte s'emporta el lote.";
            } else {
                msg = "Tothom s'ha passat! Subasta deserta.";
            }

            if (!pValid) msg += " (T'has passat!)";

            document.getElementById('round-title').textContent = winner === 'player' ? "VICT√íRIA!" : "DERROTA";
            document.getElementById('round-msg').textContent = msg + `\nObjectiu: ${target}\nTu: ${p}\nBaronessa: ${a1}\nComte: ${a2}`;

            setTimeout(() => {
                if (wins >= 3) {
                    // Save Reward
                    const rewards = JSON.parse(sessionStorage.getItem('casinoRewards') || '{}');
                    rewards['reward_subasta'] = true;
                    sessionStorage.setItem('casinoRewards', JSON.stringify(rewards));
                    document.getElementById('win-modal').style.display = 'flex';
                } else {
                    document.getElementById('result-modal').style.display = 'flex';
                }
            }, 1000);
        }

        function nextRound() {
            round++;
            startRound();
        }
    </script>
</body>

</html>