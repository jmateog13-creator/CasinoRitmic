<!DOCTYPE html>
<html lang="ca">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slots R√≠tmics</title>
    <style>
        :root {
            --felt-green: #2d5a27;
            --felt-dark: #1a3c1a;
            --wood-border: #5d4037;
            --gold: #ffd700;
            --text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            --danger-red: #ff0033;
            --wood-mahogany: #4a3728;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #111;
            font-family: 'Georgia', serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            user-select: none;
        }

        /* Start Screen */
        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a0000 0%, #000000 100%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }

        #start-screen h1 {
            font-size: 4rem;
            margin-bottom: 20px;
            color: var(--gold);
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            text-align: center;
        }

        button.start-btn {
            background: linear-gradient(to bottom, #ffd700, #b8860b);
            border: 2px solid #fff;
            padding: 20px 40px;
            font-size: 1.5rem;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            transition: transform 0.1s, filter 0.2s;
            font-family: 'Georgia', serif;
            color: #3e2723;
        }

        button.start-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }

        /* Reward Button */
        #btn-reward {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #333;
            color: #888;
            border: 2px solid #555;
            padding: 10px 20px;
            border-radius: 15px;
            cursor: not-allowed;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
            z-index: 100;
            transition: all 0.5s ease;
            max-width: 250px;
            text-align: left;
            line-height: 1.2;
        }

        #btn-reward.unlocked {
            background: linear-gradient(to bottom, #ffd700, #b8860b);
            color: #3e2723;
            border-color: #fff;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            animation: shine 2s infinite;
        }

        @keyframes shine {
            0% {
                filter: brightness(1);
            }

            50% {
                filter: brightness(1.3);
            }

            100% {
                filter: brightness(1);
            }
        }

        /* Main Game Table */
        #game-table {
            width: 95vw;
            height: 90vh;
            background: radial-gradient(circle at center, var(--felt-green), var(--felt-dark));
            border: 20px solid var(--wood-border);
            border-radius: 50px;
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.8), 0 0 20px rgba(0, 0, 0, 0.5);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        /* Texture overlay */
        #game-table::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
            pointer-events: none;
            border-radius: 30px;
        }

        #btn-menu {
            position: absolute;
            top: 20px;
            left: 20px;
            /* Moved to Left */
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: 1px solid #ffd700;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            text-decoration: none;
            font-family: 'Georgia', serif;
            z-index: 1000;
            transition: background 0.2s;
        }

        #btn-menu:hover {
            background: rgba(255, 215, 0, 0.2);
        }

        /* Game Container */
        header {
            width: 100%;
            text-align: center;
            z-index: 10;
            margin-bottom: 20px;
        }

        h1.game-title {
            font-size: 3rem;
            margin: 0;
            color: var(--gold);
            text-shadow: var(--text-shadow);
            letter-spacing: 2px;
        }

        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 40px;
            font-size: 1.5rem;
            margin-top: 10px;
            text-shadow: var(--text-shadow);
            z-index: 10;
        }

        .stat-item {
            background: rgba(0, 0, 0, 0.4);
            padding: 5px 20px;
            border-radius: 15px;
            border: 1px solid var(--gold);
        }

        /* Volume Control - Top Left */
        .volume-control {
            position: absolute;
            top: 30px;
            left: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 200;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 20px;
            border: 1px solid var(--gold);
        }

        input[type=range] {
            width: 100px;
            accent-color: var(--gold);
        }

        /* Slot Machine Container */
        #slot-machine {
            position: relative;
            width: 700px;
            height: 400px;
            background: var(--wood-mahogany);
            border-radius: 30px;
            border: 8px solid #2a1d15;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8), inset 0 0 50px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            z-index: 10;
        }

        /* Reels */
        .reels-frame {
            width: 550px;
            height: 250px;
            background: #fff;
            border: 8px solid var(--gold);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            display: flex;
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.5);
        }

        .reel {
            flex: 1;
            height: 100%;
            border-right: 2px solid #ccc;
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .reel:last-child {
            border-right: none;
        }

        .symbol {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .symbol img {
            width: 80%;
            height: auto;
            max-height: 80%;
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.3));
        }

        .blur-spin {
            filter: blur(5px);
        }

        /* Payline */
        .payline {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--danger-red);
            z-index: 5;
            box-shadow: 0 0 10px var(--danger-red);
            opacity: 0.6;
            pointer-events: none;
        }

        /* Lever */
        .lever-base {
            position: absolute;
            right: -50px;
            top: 80px;
            width: 30px;
            height: 120px;
            background: #333;
            border-radius: 0 15px 15px 0;
            border: 4px solid #111;
            border-left: none;
        }

        .lever-arm {
            position: absolute;
            bottom: 15px;
            left: 5px;
            width: 15px;
            height: 100px;
            background: silver;
            transform-origin: bottom center;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
        }

        .lever-knob {
            position: absolute;
            top: -25px;
            left: -10px;
            width: 35px;
            height: 35px;
            background: var(--danger-red);
            border-radius: 50%;
            box-shadow: inset -5px -5px 10px rgba(0, 0, 0, 0.5);
        }

        .lever-pulled {
            animation: pullLever 0.5s ease-in-out;
        }

        @keyframes pullLever {
            0% {
                transform: rotateX(0deg);
            }

            50% {
                transform: rotateX(60deg) scaleY(0.8);
            }

            100% {
                transform: rotateX(0deg);
            }
        }

        /* Controls */
        #controls-area {
            margin-top: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            z-index: 10;
        }

        .bet-panel {
            display: flex;
            gap: 10px;
            background: rgba(0, 0, 0, 0.4);
            padding: 10px;
            border-radius: 15px;
            border: 1px solid var(--wood-border);
        }

        .bet-btn {
            background: linear-gradient(to bottom, #444, #222);
            color: #fff;
            border: 2px solid #666;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Georgia', serif;
            font-weight: bold;
            transition: all 0.2s;
        }

        .bet-btn:hover {
            background: #555;
            border-color: #888;
        }

        .bet-btn.active {
            background: var(--gold);
            color: #000;
            border-color: #fff;
            box-shadow: 0 0 10px var(--gold);
        }

        .bet-btn.max-bet {
            background: linear-gradient(to bottom, #ff4444, #cc0000);
            border-color: #ff0000;
        }

        .bet-btn.max-bet.active {
            background: #ff0000;
            box-shadow: 0 0 15px #ff0000;
            color: #fff;
        }

        .boost-btn {
            background: linear-gradient(to bottom, #9c27b0, #7b1fa2);
            color: #fff;
            border: 2px solid #e1bee7;
            padding: 12px 25px;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(156, 39, 176, 0.5);
            font-family: 'Georgia', serif;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Message Area */
        #message-area {
            margin-top: 15px;
            height: 30px;
            font-size: 1.5rem;
            color: var(--gold);
            text-shadow: 1px 1px 2px #000;
            text-align: center;
            font-weight: bold;
        }

        /* Modals */
        #quiz-modal,
        #reward-modal,
        #gameover-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 500;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: linear-gradient(135deg, #2d5a27, #1a3316);
            border: 4px solid var(--gold);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 600px;
            color: #fff;
            box-shadow: 0 0 50px var(--gold);
        }

        .quiz-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .quiz-btn {
            background: #fff;
            color: #000;
            border: none;
            padding: 15px;
            font-size: 1.2rem;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.1s;
            font-family: 'Georgia', serif;
        }

        .quiz-btn:hover {
            transform: scale(1.05);
            background: var(--gold);
        }

        /* Confetti */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--gold);
            animation: fall linear forwards;
            z-index: 1000;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(720deg);
            }
        }

        /* Instructions Modal Styles */
        #instructions-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .instr-content {
            background: #1a0505;
            padding: 40px;
            border: 4px double var(--gold);
            text-align: center;
            max-width: 600px;
            color: #fff;
            position: relative;
        }

        .instr-close {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #aaa;
            font-size: 2rem;
            cursor: pointer;
        }

        .instr-btn {
            padding: 10px 30px;
            font-size: 1.2rem;
            background: var(--gold);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            color: #1a0505;
            margin-top: 20px;
        }
    </style>
</head>

<body>

    <div id="start-screen">
        <h1>SLOTS R√çTMICS</h1>
        <p style="font-size: 1.5rem; margin-bottom: 30px;">Benvingut al Casino de Beethoven</p>
        <button class="start-btn" onclick="initGame()">ENTRAR AL CASINO</button>
    </div>

    <!-- Reward Button -->
    <button id="btn-reward" onclick="claimReward()">
        <span style="font-size: 1.5rem;">üîí</span>
        <span>Aconseguir el Fon√≤graf d'Edison (5000 ü™ô)</span>
    </button>

    <!-- Menu Button -->
    <a href="menu.html" id="btn-menu">üè† MEN√ö</a>

    <div id="game-table">
        <!-- Instructions Modal -->
        <div id="instructions-modal">
            <div class="instr-content">
                <span class="instr-close"
                    onclick="document.getElementById('instructions-modal').style.display='none'">√ó</span>
                <h2 style="color: var(--gold);">COM JUGAR</h2>
                <p style="font-size:1.2rem;">Fes girar els rodets i aconsegueix combinacions de figures musicals!</p>
                <p>Aconsegueix 3 figures iguals per guanyar premis.</p>
                <p>Arriba a 5000 fitxes per desbloquejar la rel√≠quia!</p>
                <button class="instr-btn"
                    onclick="document.getElementById('instructions-modal').style.display='none'">JUGAR</button>
            </div>
        </div>

        <!-- Volume Control -->
        <div class="volume-control">
            <button id="mute-btn" onclick="toggleMute()"
                style="background:none; border:none; font-size: 1.5rem; cursor: pointer;">üîä</button>
            <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="0.5">
        </div>

        <header>
            <h1 class="game-title">SLOTS R√çTMICS</h1>
            <div class="stats-bar">
                <div class="stat-item">FITXES: <span id="balance">1000</span> ü™ô</div>
                <div class="stat-item">APOSTA: <span id="current-bet-display">100</span> ü™ô</div>
            </div>
        </header>

        <div id="slot-machine">
            <div class="reels-frame">
                <div class="payline"></div>
                <div class="reel" id="reel-1">
                    <div class="symbol"></div>
                </div>
                <div class="reel" id="reel-2">
                    <div class="symbol"></div>
                </div>
                <div class="reel" id="reel-3">
                    <div class="symbol"></div>
                </div>
            </div>

            <div class="lever-base">
                <div class="lever-arm" id="lever">
                    <div class="lever-knob"></div>
                </div>
            </div>

            <div id="message-area">Prem la palanca per girar!</div>

            <div id="controls-area">
                <div class="bet-panel">
                    <button class="bet-btn" data-bet="50">50</button>
                    <button class="bet-btn active" data-bet="100">100</button>
                    <button class="bet-btn" data-bet="250">250</button>
                    <button class="bet-btn max-bet" data-bet="500">TOT O RES</button>
                </div>
                <button class="boost-btn" id="boost-btn">BOOST DE SORT ‚ú®</button>
            </div>
        </div>
    </div>

    <!-- Quiz Modal -->
    <div id="quiz-modal">
        <div class="modal-content">
            <h2 style="color: var(--gold);">PREGUNTA R√çTMICA</h2>
            <p id="quiz-question" style="font-size: 1.5rem; margin: 20px 0;">Pregunta...</p>
            <div class="quiz-options" id="quiz-options">
                <!-- Options -->
            </div>
        </div>
    </div>

    <!-- Reward Modal -->
    <div id="reward-modal">
        <div class="modal-content">
            <div style="font-size: 5rem;">üìª</div>
            <h2 style="color: var(--gold);">PREMI HIST√íRIC!</h2>
            <p>Has aconseguit 5000 fitxes!</p>
            <p>Aqu√≠ tens la teva rel√≠quia:</p>
            <h3 style="color: var(--gold); font-size: 2rem;">EL FON√íGRAF D'EDISON</h3>
            <p style="font-size: 1rem; opacity: 0.8;">"La primera m√†quina capa√ß de gravar i reproduir so (1877)."</p>
            <button class="quiz-btn" onclick="location.reload()">TORNAR A JUGAR</button>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div id="gameover-modal">
        <div class="modal-content">
            <h2 style="color: #ff4444;">SENSE FITXES...</h2>
            <p>La casa sempre guanya.</p>
            <button class="quiz-btn" onclick="location.reload()">REINICIAR</button>
        </div>
    </div>

    <!-- Audio -->
    <audio id="bg-music" loop>
        <source src="music/background_music_tragaperras.mp3" type="audio/mpeg">
    </audio>

    <script>
        // --- DATA ---
        const SYMBOLS = [
            { id: 'rodona', val: 50, img: 'images/rodona.jpg', name: 'RODONA' },
            { id: 'blanca', val: 20, img: 'images/blanca.jpg', name: 'BLANCA' },
            { id: 'negra', val: 10, img: 'images/negra.jpg', name: 'NEGRA' },
            { id: 'corxera', val: 5, img: 'images/corxera.jpg', name: 'CORXERA' },
            { id: 'semicorxera', val: 2, img: 'images/semicorxera.jpg', name: 'SEMICORXERA' }
        ];

        const QUIZ_DATA = [
            { q: "Quant sumen Blanca + Negra?", a: ["3 Temps", "2 Temps", "4 Temps", "1.5 Temps"], correct: 0 },
            { q: "Quina figura val la meitat d'una Rodona?", a: ["Blanca", "Negra", "Corxera", "Semicorxera"], correct: 0 },
            { q: "Quant val una Negra?", a: ["1 Temps", "2 Temps", "0.5 Temps", "4 Temps"], correct: 0 },
            { q: "Dues Corxeres equivalen a...", a: ["Una Negra", "Una Blanca", "Una Semicorxera", "Tres Negres"], correct: 0 },
            { q: "Quina figura √©s la m√©s r√†pida?", a: ["Semicorxera", "Corxera", "Negra", "Blanca"], correct: 0 }
        ];

        // --- STATE ---
        let state = {
            balance: 1000,
            currentBet: 100,
            isSpinning: false,
            isBoosted: false,
            boostMultiplier: 1,
            isSpinning: false,
            isBoosted: false,
            boostMultiplier: 1,
            rewardUnlocked: false,
            isMuted: false,
            previousVolume: 0.5
        };

        // --- AUDIO ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;
        const bgMusic = document.getElementById('bg-music');

        function initGame() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('instructions-modal').style.display = 'flex';
            audioCtx = new AudioContext();
            bgMusic.volume = 0.5;
            bgMusic.play().catch(e => console.log("Music failed", e));

            // Init Reels with random symbols
            [1, 2, 3].forEach(i => {
                const rand = SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)];
                setReelSymbol(i - 1, rand);
            });
        }

        function playSound(type) {
            if (!audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            const now = audioCtx.currentTime;

            switch (type) {
                case 'spin':
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(100, now);
                    osc.frequency.linearRampToValueAtTime(50, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start(now);
                    osc.stop(now + 0.1);
                    break;
                case 'stop':
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(200, now);
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start(now);
                    osc.stop(now + 0.05);
                    break;
                case 'win':
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(800, now);
                    osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
                    gain.gain.setValueAtTime(0.3, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start(now);
                    osc.stop(now + 0.5);
                    break;
                case 'jackpot':
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(600, now);
                    osc.frequency.linearRampToValueAtTime(1200, now + 0.5);
                    osc.frequency.linearRampToValueAtTime(600, now + 1.0);
                    gain.gain.setValueAtTime(0.3, now);
                    gain.gain.linearRampToValueAtTime(0, now + 2.0);
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start(now);
                    osc.stop(now + 2.0);
                    break;
            }
        }

        // --- DOM ---
        const balanceEl = document.getElementById('balance');
        const betDisplayEl = document.getElementById('current-bet-display');
        const lever = document.getElementById('lever');
        const messageArea = document.getElementById('message-area');
        const boostBtn = document.getElementById('boost-btn');
        const quizModal = document.getElementById('quiz-modal');
        const rewardModal = document.getElementById('reward-modal');
        const gameoverModal = document.getElementById('gameover-modal');
        const volumeSlider = document.getElementById('volume-slider');
        const btnReward = document.getElementById('btn-reward');

        // --- EVENTS ---
        document.querySelectorAll('.bet-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (state.isSpinning) return;
                document.querySelectorAll('.bet-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.currentBet = parseInt(btn.dataset.bet);
                betDisplayEl.textContent = state.currentBet;
            });
        });

        lever.addEventListener('click', spin);
        boostBtn.addEventListener('click', startQuiz);

        volumeSlider.addEventListener('input', (e) => {
            const val = e.target.value;

            if (state.isMuted) {
                state.isMuted = false;
                document.getElementById('mute-btn').textContent = "üîä";
            }

            bgMusic.volume = val;
            updateMuteIcon(val);
        });

        function toggleMute() {
            state.isMuted = !state.isMuted;
            const icon = document.getElementById('mute-btn');

            if (state.isMuted) {
                state.previousVolume = bgMusic.volume;
                bgMusic.volume = 0;
                icon.textContent = "üîá";
            } else {
                bgMusic.volume = volumeSlider.value;
                updateMuteIcon(bgMusic.volume);
            }
        }

        function updateMuteIcon(val) {
            const icon = document.getElementById('mute-btn');
            if (val == 0) icon.textContent = "üîá";
            else if (val < 0.5) icon.textContent = "üîâ";
            else icon.textContent = "üîä";
        }

        // --- LOGIC ---

        function startQuiz() {
            if (state.isSpinning) return;
            const q = QUIZ_DATA[Math.floor(Math.random() * QUIZ_DATA.length)];
            document.getElementById('quiz-question').textContent = q.q;
            const optsDiv = document.getElementById('quiz-options');
            optsDiv.innerHTML = '';

            let answers = q.a.map((ans, i) => ({ txt: ans, isCorrect: i === q.correct }));
            answers.sort(() => Math.random() - 0.5);

            answers.forEach(ans => {
                const btn = document.createElement('button');
                btn.className = 'quiz-btn';
                btn.textContent = ans.txt;
                btn.onclick = () => resolveQuiz(ans.isCorrect);
                optsDiv.appendChild(btn);
            });

            quizModal.style.display = 'flex';
        }

        function resolveQuiz(correct) {
            quizModal.style.display = 'none';
            if (correct) {
                state.isBoosted = true;
                messageArea.textContent = "SORT AUGMENTADA AL M√ÄXIM! ‚ú®";
                messageArea.style.color = "#00ff00";
                boostBtn.disabled = true;
                boostBtn.style.opacity = 0.5;
            } else {
                messageArea.textContent = "MALA SORT... Bloqueig temporal.";
                messageArea.style.color = "#ff0000";
                lever.style.pointerEvents = 'none';
                setTimeout(() => {
                    lever.style.pointerEvents = 'auto';
                    messageArea.textContent = "Prem la palanca per girar!";
                    messageArea.style.color = "var(--gold)";
                }, 2000);
            }
        }

        async function spin() {
            if (state.isSpinning) return;
            if (state.balance < state.currentBet) {
                messageArea.textContent = "No tens prous fitxes!";
                return;
            }

            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();

            state.isSpinning = true;
            state.balance -= state.currentBet;
            updateUI();
            messageArea.textContent = "Girant...";
            messageArea.style.color = "var(--gold)";

            lever.classList.add('lever-pulled');
            setTimeout(() => lever.classList.remove('lever-pulled'), 500);

            // Determine Result
            let result = [
                Math.floor(Math.random() * SYMBOLS.length),
                Math.floor(Math.random() * SYMBOLS.length),
                Math.floor(Math.random() * SYMBOLS.length)
            ];

            if (state.isBoosted) {
                if (Math.random() > 0.5) {
                    const sym = Math.floor(Math.random() * 3);
                    result = [sym, sym, sym];
                } else {
                    const sym = Math.floor(Math.random() * SYMBOLS.length);
                    result = [sym, sym, (sym + 1) % SYMBOLS.length];
                }
                state.isBoosted = false;
                boostBtn.disabled = false;
                boostBtn.style.opacity = 1;
            }

            // Spin Animation
            const spinDuration = 2000;
            const reels = [0, 1, 2];

            // Start spinning sound loop
            const spinInterval = setInterval(() => playSound('spin'), 100);

            // Animate reels
            const animations = reels.map((reelIdx, i) => {
                return new Promise(resolve => {
                    const reelEl = document.getElementById(`reel-${reelIdx + 1}`).querySelector('.symbol');
                    // Rapidly change image
                    const animInt = setInterval(() => {
                        const randSym = SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)];
                        reelEl.innerHTML = `<img src="${randSym.img}" style="width:90%; height:auto;" class="blur-spin">`;
                    }, 100);

                    // Stop after delay
                    setTimeout(() => {
                        clearInterval(animInt);
                        setReelSymbol(reelIdx, SYMBOLS[result[reelIdx]]);
                        playSound('stop');
                        resolve();
                    }, spinDuration + (i * 500));
                });
            });

            await Promise.all(animations);

            clearInterval(spinInterval);
            checkWin(result);
            state.isSpinning = false;
        }

        function setReelSymbol(reelIndex, symbolObj) {
            const reelEl = document.getElementById(`reel-${reelIndex + 1}`).querySelector('.symbol');
            reelEl.innerHTML = `<img src="${symbolObj.img}" style="width:90%; height:auto;">`;
        }

        function checkWin(result) {
            const s1 = SYMBOLS[result[0]];
            const s2 = SYMBOLS[result[1]];
            const s3 = SYMBOLS[result[2]];

            let winAmount = 0;
            let message = "";
            let isJackpot = false;

            if (s1.id === s2.id && s2.id === s3.id) {
                winAmount = state.currentBet * getMultiplier(s1.id);
                message = `TRIPLE ${s1.name}! +${winAmount}`;
                isJackpot = s1.id === 'rodona';
                playSound(isJackpot ? 'jackpot' : 'win');
            } else if (s1.id === s2.id || s2.id === s3.id || s1.id === s3.id) {
                winAmount = state.currentBet;
                message = "PARELLA! Recuperes l'aposta.";
                playSound('stop');
            } else {
                message = "Res... Torna-ho a provar.";
            }

            if (winAmount > 0) {
                state.balance += winAmount;
                messageArea.style.color = "#00ff00";
                if (isJackpot) createConfetti();
            } else {
                messageArea.style.color = "#fff";
            }

            updateUI();
            messageArea.textContent = message;

            if (state.balance <= 0) {
                setTimeout(() => {
                    gameoverModal.style.display = 'flex';
                }, 1000);
            }
        }

        function updateUI() {
            balanceEl.textContent = state.balance;

            // Check Reward Unlock
            if (state.balance >= 5000 && !state.rewardUnlocked) {
                state.rewardUnlocked = true;
                btnReward.classList.add('unlocked');
                btnReward.innerHTML = '<span style="font-size: 1.5rem;">üìª</span><span>Aconseguir el Fon√≤graf d\'Edison</span>';
                playSound('jackpot');
                createConfetti();

                // Save Reward
                const rewards = JSON.parse(sessionStorage.getItem('casinoRewards') || '{}');
                rewards['reward_slots'] = true;
                sessionStorage.setItem('casinoRewards', JSON.stringify(rewards));

                // Redirect
                // setTimeout(() => {
                //     window.location.href = 'menu.html';
                // }, 4000);
            }
        }

        function claimReward() {
            if (state.rewardUnlocked) {
                rewardModal.style.display = 'flex';
                playSound('jackpot');
                createConfetti();
            }
        }

        function getMultiplier(id) {
            switch (id) {
                case 'rodona': return 50;
                case 'blanca': return 20;
                case 'negra': return 10;
                case 'corxera': return 5;
                case 'semicorxera': return 2;
                default: return 0;
            }
        }

        function createConfetti() {
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                document.body.appendChild(confetti);
            }
        }

    </script>
</body>

</html>